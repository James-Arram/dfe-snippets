import com.maxeler.maxcompiler.v2.kernelcompiler.Kernel;
import com.maxeler.maxcompiler.v2.kernelcompiler.KernelParameters;
import com.maxeler.maxcompiler.v2.kernelcompiler.types.base.DFEVar;
import com.maxeler.maxcompiler.v2.kernelcompiler.types.composite.DFEVectorType;
import com.maxeler.maxcompiler.v2.kernelcompiler.types.composite.DFEVector;

import com.custom_computing_ic.dfe_snippets.utils.FetchSubTuple;

class ParallelCsrDecoderKernel extends Kernel {

    protected ParallelCsrDecoderKernel(KernelParameters parameters, int inputWidth) {
        super(parameters);

        DFEVectorType<DFEVar> vtype = new DFEVectorType<DFEVar> (dfeFloat(11, 53), inputWidth);

        FetchSubTuple fst = new FetchSubTuple(this, "fst", inputWidth, 64, dfeFloat(11, 53), true);

        DFEVector<DFEVar> a = io.input("a", vtype);

        DFEVar colptr = io.input("length", dfeUInt(32));

        fst.push(constant.var(true), a); //

        io.output("output", fst.pop(colptr), vtype);
    }
}

class ParallelKernelTwo extends Kernel {

  protected ParallelKernelTwo(KernelParameters parameters, int inputWidth) {
    super(parameters);
    DFEVectorType<DFEVar> vtype = new DFEVectorType<DFEVar> (dfeFloat(11, 53), inputWidth);
    DFEVar readEnable = io.input("readenable", dfeUInt(32));
    DFEVector<DFEVar> a = io.input("a", vtype, readEnable === 1);

    DFEVar readMask = io.input("readmask", dfeUInt(32));

    DFEVector<DFEVar> out = vtype.newInstance(this);
    for (int i = 0; i < inputWidth; i++) {
      out[i] <== readMask.slice(i) === 0 ?
        0 : a[i];
    }

    io.output("output", out, vtype);
  }
}

